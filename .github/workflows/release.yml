name: tag release
on: workflow_dispatch
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'
          scope: '@oneteme'
      - run: npm install
      - run: npm run build '@oneteme/inspect-ng-collector'
      - run: npm config ls
      - run: npm publish ./dist/oneteme/inspect-ng-collector --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: extract version
        id: npmVer
        run: echo "version=$(node -p 'require("./projects/oneteme/inspect-ng-collector/package.json").version')" >>$GITHUB_OUTPUT
    outputs:
      version: ${{ steps.npmVer.outputs.version }}
  release:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
    - name: release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        branch: "${{ github.ref_name }}"
        version: "v${{ needs.deploy.outputs.version }}"
      run: gh release create "$version" --repo="$GITHUB_REPOSITORY" --target="$branch" --title="$version" --generate-notes
